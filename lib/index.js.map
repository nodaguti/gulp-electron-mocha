{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import fs from 'fs-promise';\nimport through from 'through2';\nimport { spawn } from 'child_process';\nimport path from 'path';\nimport assign from 'object-assign';\nimport toSpawnArgs from 'object-to-spawn-args';\nimport gutil from 'gulp-util';\n\nconst PluginError = gutil.PluginError;\nconst pluginName = require('../package.json').name;\n\nexport default function (opts = {}) {\n  const electronPath = opts.electronPath || getElectronPath();\n  const electronMochaPath = lookup('electron-mocha/bin/electron-mocha', false);\n\n  if (!electronPath) {\n    throw new PluginError(pluginName, 'Cannot find electron.');\n  }\n\n  if (!electronMochaPath) {\n    throw new PluginError(pluginName, 'Cannot find electron-mocha.');\n  }\n\n  opts.electronMocha = toSpawnArgs(opts.electronMocha || {});\n\n  return through.obj(function(file, enc, cb) {\n    const paths = {\n      electronMocha: electronMochaPath,\n      electron: electronPath,\n      file: file.path,\n    };\n    spawnElectronMocha(paths, opts, this, (err) => {\n      if (err) {\n        return cb(err);\n      }\n\n      this.push(file);\n      cb();\n    });\n  });\n}\n\nfunction getElectronPath() {\n  const electronPathFile = lookup('electron-prebuilt/path.txt');\n  var electronExecPath = fs.readFileSync(electronPathFile, 'utf8');\n  return lookup(path.join('electron-prebuilt',electronExecPath));\n}\n\nfunction spawnElectronMocha(paths, opts, stream, cb) {\n  const args = [paths.electronMocha, ...opts.electronMocha, paths.file];\n  const env = assign(process.env, { 'ELECTRON_PATH': paths.electron });\n  const electronMocha = spawn(process.argv[0], args, { env });\n\n  if (!opts.suppressStdout) {\n    electronMocha.stdout.pipe(process.stdout);\n  }\n\n  if (!opts.suppressStderr) {\n    electronMocha.stderr.pipe(process.stderr);\n  }\n\n  electronMocha.stdout.on('data', stream.emit.bind(stream, 'electronMochaStdoutData'));\n  electronMocha.stdout.on('end', stream.emit.bind(stream, 'electronMochaStdoutEnd'));\n\n  electronMocha.stderr.on('data', stream.emit.bind(stream, 'electronMochaStderrData'));\n  electronMocha.stderr.on('end', stream.emit.bind(stream, 'electronMochaStderrEnd'));\n\n  electronMocha.on('error', stream.emit.bind(stream, 'electronMochaError'));\n  electronMocha.on('exit', stream.emit.bind(stream, 'electronMochaExit'));\n\n  electronMocha.on('error', function (err) {\n      cb(new gutil.PluginError(pluginName, err.message));\n  });\n\n  electronMocha.on('exit', function (code) {\n    if (code === 0 || opts.silent) {\n      cb();\n    } else {\n      cb(new gutil.PluginError(pluginName, 'Test failed. electronMocha exit code: ' + code));\n    }\n  });\n}\n\nexport function lookup(pathToLookup, isExecutable) {\n  const iz = module.paths.length;\n\n  for (let i = 0; i < iz; i++) {\n    let absPath = path.join(module.paths[i], pathToLookup);\n\n    if (isExecutable && process.platform === 'win32') {\n      absPath += '.cmd';\n    }\n\n    try {\n      const stat = fs.statSync(absPath);\n\n      if (stat) {\n        return absPath;\n      }\n    } catch(err) {\n      continue;\n    }\n  }\n\n  return '';\n}\n"]}