{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import fs from 'fs-promise';\nimport through from 'through2';\nimport { spawn } from 'child_process';\nimport path from 'path';\nimport assign from 'object-assign';\nimport toSpawnArgs from 'object-to-spawn-args';\nimport gutil from 'gulp-util';\n\nconst PluginError = gutil.PluginError;\nconst pluginName = require('../package.json').name;\n\nexport function lookup(pathToLookup, isExecutable) {\n  const iz = module.paths.length;\n\n  for (let i = 0; i < iz; i++) {\n    let absPath = path.join(module.paths[i], pathToLookup);\n\n    if (isExecutable && process.platform === 'win32') {\n      absPath += '.cmd';\n    }\n\n    try {\n      const stat = fs.statSync(absPath);\n\n      if (stat) {\n        return absPath;\n      }\n    } catch (err) {\n      continue;\n    }\n  }\n\n  return '';\n}\n\nfunction getElectronPath() {\n  const electronPathFile = lookup('electron-prebuilt/path.txt');\n  return fs.readFileSync(electronPathFile, 'utf8');\n}\n\nfunction spawnElectronMocha(paths, opts, stream, cb) {\n  const args = [...opts.electronMocha, paths.file];\n  const env = assign(process.env, { ELECTRON_PATH: paths.electron });\n  const electronMocha = spawn(paths.electronMocha, args, { env });\n\n  if (!opts.suppressStdout) {\n    electronMocha.stdout.pipe(process.stdout);\n  }\n\n  if (!opts.suppressStderr) {\n    electronMocha.stderr.pipe(process.stderr);\n  }\n\n  electronMocha.stdout.on('data', stream.emit.bind(stream, 'electronMochaStdoutData'));\n  electronMocha.stdout.on('end', stream.emit.bind(stream, 'electronMochaStdoutEnd'));\n\n  electronMocha.stderr.on('data', stream.emit.bind(stream, 'electronMochaStderrData'));\n  electronMocha.stderr.on('end', stream.emit.bind(stream, 'electronMochaStderrEnd'));\n\n  electronMocha.on('error', stream.emit.bind(stream, 'electronMochaError'));\n  electronMocha.on('exit', stream.emit.bind(stream, 'electronMochaExit'));\n\n  electronMocha.on('error', (err) => {\n    cb(new gutil.PluginError(pluginName, err.message));\n  });\n\n  electronMocha.on('exit', (code) => {\n    if (code === 0 || opts.silent) {\n      cb();\n    } else {\n      cb(new gutil.PluginError(pluginName, `Test failed. electronMocha exit code: ${code}`));\n    }\n  });\n}\n\nexport default function (opts = {}) {\n  const electronPath = opts.electronPath || getElectronPath();\n  const electronMochaPath = lookup('electron-mocha/bin/electron-mocha', true);\n\n  if (!electronPath) {\n    throw new PluginError(pluginName, 'Cannot find electron.');\n  }\n\n  if (!electronMochaPath) {\n    throw new PluginError(pluginName, 'Cannot find electron-mocha.');\n  }\n\n  // We intentionally reassign to the func param in order to spawn args.\n  // eslint-disable-next-line no-param-reassign\n  opts.electronMocha = toSpawnArgs(opts.electronMocha || {});\n\n  return through.obj(function spawnProcess(file, enc, cb) {\n    const paths = {\n      electronMocha: electronMochaPath,\n      electron: electronPath,\n      file: file.path,\n    };\n\n    spawnElectronMocha(paths, opts, this, (err) => {\n      if (err) {\n        cb(err);\n        return;\n      }\n\n      this.push(file);\n      cb();\n    });\n  });\n}\n"]}